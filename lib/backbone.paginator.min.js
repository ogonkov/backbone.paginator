(function(a){if("object"==typeof exports&&"function"==typeof require)module.exports=a(require("underscore"),require("backbone"));else if("function"==typeof define&&define.amd)define(["underscore","backbone"],a);else if("undefined"!=typeof _&&"undefined"!=typeof Backbone){const b=Backbone.PageableCollection,c=a(_,Backbone);Backbone.PageableCollection.noConflict=function(){return Backbone.PageableCollection=b,c}}})(function(a,b){"use strict";function c(b,c){if(!a.isNumber(b)||a.isNaN(b)||!a.isFinite(b)||~~b!==b)throw new TypeError("`"+c+"` must be a finite integer");return b}function d(a){const b={},c=decodeURIComponent,d=a.split("&");for(const e of d){let[a,d]=e.split("=");null==d&&(d=!0),a=c(a),d=c(d);const f=b[a];o(f)?f.push(d):f?b[a]=[f,d]:b[a]=d}return b}function e(a,b,c){const d=a._events[b];if(d&&d.length){const a=d[d.length-1],b=a.callback;a.callback=function(){try{b.apply(this,arguments),c()}catch(a){throw a}finally{a.callback=b}}}else c()}const f=a.extend,g=a.omit,h=a.clone,i=a.each,j=a.pick,k=a.includes,l=a.isEmpty,m=a.pairs||a.toPairs,n=a.invert,o=a.isArray,p=a.isFunction,q=a.isObject,r=a.keys,s=a.isUndefined,t=Math.ceil,u=Math.floor,v=Math.max,w=b.Collection.prototype,x=/[\s'"]/g,y=/[<>\s'"]/g,z=b.PageableCollection=b.Collection.extend({state:{firstPage:1,lastPage:null,currentPage:null,pageSize:25,totalPages:null,totalRecords:null,sortKey:null,order:-1},mode:"server",queryParams:{currentPage:"page",pageSize:"per_page",totalPages:"total_pages",totalRecords:"total_entries",sortKey:"sort_by",order:"order",directions:{"-1":"asc",1:"desc"}},constructor:function(a,b){w.constructor.apply(this,arguments),b=b||{};const c=this.mode=b.mode||this.mode||A.mode,d=f({},A.queryParams,this.queryParams,b.queryParams||{});d.directions=f({},A.queryParams.directions,this.queryParams.directions,d.directions),this.queryParams=d;const e=this.state=f({},A.state,this.state,b.state);e.currentPage=null==e.currentPage?e.firstPage:e.currentPage,o(a)||(a=a?[a]:[]),a=a.slice(),"server"==c||null!=e.totalRecords||l(a)||(e.totalRecords=this.length),this.switchMode(c,f({fetch:!1,resetState:!1,models:a},b));const g=b.comparator;if(e.sortKey&&!g&&this.setSorting(e.sortKey,e.order,b),"server"!=c){const c=this.fullCollection;g&&b.full&&(this.comparator=null,c.comparator=g),b.full&&c.sort(),l(a)||this.getPage(e.currentPage)}this._initState=h(this.state)},_makeFullCollection:function(a,c){const d=["url","model","sync","comparator"],e=this.constructor.prototype,f={};for(let b=0,g=d.length;b<g;b++){const a=d[b];s(e[a])||(f[a]=e[a])}const g=new(b.Collection.extend(f))(a,c);for(let b=0,f=d.length;b<f;b++){const a=d[b];this[a]!==e[a]&&(g[a]=this[a])}return g},_makeCollectionEventHandler:function(a,b){return function(c,d,g,j={}){const k=a._handlers;i(r(k),function(c){const d=k[c];a.off(c,d),b.off(c,d)});const l=h(a.state);let m=l.firstPage,n=0===m?l.currentPage:l.currentPage-1;const o=l.pageSize;let p=n*o,q=p+o;if("add"==c){let h,i,k,m;if(g==b?(i=b.indexOf(d),i>=p&&i<q&&(m=a,h=k=i-p)):(h=a.indexOf(d),i=p+h,m=b,k=s(j.at)?i:j.at+p),j.onRemove||(++l.totalRecords,delete j.onRemove),a.state=a._checkState(l),m){m.add(d,f({},j,{at:k}));const b=h>=o?d:!s(j.at)&&k<q&&a.length>o?a.at(o):null;b&&e(g,c,function(){a.remove(b,{onAdd:!0})})}j.silent||a.trigger("pageable:state:change",a.state)}if("remove"==c){if(!j.onAdd){if(! --l.totalRecords)l.totalRecords=null,l.totalPages=null;else{const a=l.totalPages=t(l.totalRecords/o);l.lastPage=0===m?a-1:a||m,l.currentPage>a&&(l.currentPage=l.lastPage)}a.state=a._checkState(l);let h;const i=j.index;g==a?((h=b.at(q))?e(a,c,function(){a.push(h,{onRemove:!0})}):!a.length&&l.totalRecords&&a.reset(b.models.slice(p-o,q-o),f({},j,{parse:!1})),b.remove(d)):i>=p&&i<q&&((h=b.at(q-1))&&e(a,c,function(){a.push(h,{onRemove:!0})}),a.remove(d),!a.length&&l.totalRecords&&a.reset(b.models.slice(p-o,q-o),f({},j,{parse:!1})))}else delete j.onAdd;j.silent||a.trigger("pageable:state:change",a.state)}if("reset"==c){const c=g;if(g=d,g==a&&null==c.from&&null==c.to){const d=b.models.slice(0,p),e=b.models.slice(p+a.models.length);b.reset(d.concat(a.models).concat(e),c)}else g==b&&((l.totalRecords=b.models.length)||(l.totalRecords=null,l.totalPages=null),"client"==a.mode&&(m=l.lastPage=l.currentPage=l.firstPage,n=0===m?l.currentPage:l.currentPage-1,p=n*o,q=p+o),a.state=a._checkState(l),a.reset(b.models.slice(p,q),f({},c,{parse:!1})));c.silent||a.trigger("pageable:state:change",a.state)}if("sort"==c){const c=g;g=d,g===b&&a.reset(b.models.slice(p,q),f({},c,{parse:!1}))}i(r(k),function(c){const d=k[c];i([a,b],function(a){a.on(c,d);const b=a._events[c]||[];b.unshift(b.pop())})})}},_checkState:function(a){const b=this.mode,d=this.links;let e=a.totalRecords,f=a.pageSize,g=a.currentPage,h=a.firstPage,i=a.totalPages;if(null!=e&&null!=f&&null!=g&&null!=h&&("infinite"!=b||d)){if(e=c(e,"totalRecords"),f=c(f,"pageSize"),g=c(g,"currentPage"),h=c(h,"firstPage"),1>f)throw new RangeError("`pageSize` must be >= 1");if(i=a.totalPages=t(e/f),0>h||1<h)throw new RangeError("`firstPage must be 0 or 1`");if(a.lastPage=0===h?v(0,i-1):i||h,"infinite"==b){if(!d[g])throw new RangeError("No link found for page "+g);}else if(g<h||0<i&&(h?g>i:g>=i))throw new RangeError("`currentPage` must be firstPage <= currentPage "+(h?"<":"<=")+" totalPages if "+h+"-based. Got "+g+".")}return a},setPageSize:function(a,b){a=c(a,"pageSize"),b=b||{first:!1};let d=this.state;const e=t(d.totalRecords/a),h=e?v(d.firstPage,u(e*d.currentPage/d.totalPages)):d.firstPage;return d=this.state=this._checkState(f({},d,{pageSize:a,currentPage:b.first?d.firstPage:h,totalPages:e})),this.getPage(d.currentPage,g(b,["first"]))},switchMode:function(b,c){if(!k(["server","client","infinite"],b))throw new TypeError("`mode` must be one of \"server\", \"client\" or \"infinite\"");c=c||{fetch:!0,resetState:!0};const d=this.state=c.resetState?h(this._initState):this._checkState(f({},this.state));this.mode=b;const e=this;let j=this.fullCollection;const l=this._handlers=this._handlers||{};if("server"!=b&&!j){j=this._makeFullCollection(c.models||[],c),j.pageableCollection=this,this.fullCollection=j;const b=this._makeCollectionEventHandler(this,j);i(["add","remove","reset","sort"],function(c){let d;l[c]=d=a.bind(b,{},c),e.on(c,d),j.on(c,d)}),j.comparator=this._fullComparator}else"server"==b&&j&&(i(r(l),function(a){const b=l[a];e.off(a,b),j.off(a,b)}),delete this._handlers,this._fullComparator=j.comparator,delete this.fullCollection);if("infinite"==b){const a=this.links={},b=d.firstPage,c=t(d.totalRecords/d.pageSize),e=0===b?v(0,c-1):c||b;for(let b=d.firstPage;b<=e;b++)a[b]=this.url}else this.links&&delete this.links;return c.silent||this.trigger("pageable:state:change",d),c.fetch?this.fetch(g(c,"fetch","resetState")):this},hasPreviousPage:function(){const a=this.state,b=a.currentPage;return"infinite"==this.mode?!!this.links[b-1]:b>a.firstPage},hasNextPage:function(){const a=this.state,b=this.state.currentPage;return"infinite"==this.mode?!!this.links[b+1]:b<a.lastPage},getFirstPage:function(a){return this.getPage("first",a)},getPreviousPage:function(a){return this.getPage("prev",a)},getNextPage:function(a){return this.getPage("next",a)},getLastPage:function(a){return this.getPage("last",a)},getPage:function(a,b){const d=this.mode,e=this.fullCollection;b=b||{fetch:!1};const h=this.state,i=h.firstPage,j=h.currentPage,k=h.lastPage,m=h.pageSize;let n=a;n="first"===a?i:"prev"===a?j-1:"next"===a?j+1:"last"===a?k:c(a,"index"),this.state=this._checkState(f({},h,{currentPage:n})),b.silent||this.trigger("pageable:state:change",this.state),b.from=j,b.to=n;const o=(0===i?n:n-1)*m,p=e&&e.length?e.models.slice(o,o+m):[];return"client"!=d&&("infinite"!=d||l(p))||b.fetch?("infinite"==d&&(b.url=this.links[n]),this.fetch(g(b,"fetch"))):(this.reset(p,g(b,"fetch")),this)},getPageByOffset:function(a,b){if(0>a)throw new RangeError("`offset must be > 0`");a=c(a,"offset");let d=u(a/this.state.pageSize);return 0!==this.state.firstPage&&d++,d>this.state.lastPage&&(d=this.state.lastPage),this.getPage(d,b)},sync:function(a,c,d){const e=this;if("infinite"==e.mode){const a=d.success,b=e.state.currentPage;d.success=function(c,g,h){const i=e.links,j=e.parseLinks(c,f({xhr:h},d));j.first&&(i[e.state.firstPage]=j.first),j.prev&&(i[b-1]=j.prev),j.next&&(i[b+1]=j.next),a&&a(c,g,h)}}return(w.sync||b.sync).call(e,a,c,d)},parseLinks:function(a,b){const c={},d=b.xhr.getResponseHeader("Link");if(d){const a=["first","prev","next"];i(d.split(","),function(b){const d=b.split(";"),e=d[0].replace(y,""),f=d.slice(1);i(f,function(b){const d=b.split("="),f=d[0].replace(x,""),g=d[1].replace(x,"");"rel"==f&&k(a,g)&&(c[g]=e)})})}return c},parse:function(a,b){const c=this.parseState(a,h(this.queryParams),h(this.state),b);return c&&(this.state=this._checkState(f({},this.state,c)),!(b||{}).silent&&this.trigger("pageable:state:change",this.state)),this.parseRecords(a,b)},parseState:function(b,c,d){if(b&&2===b.length&&q(b[0])&&o(b[1])){const e=h(d),f=b[0];return i(m(g(c,"directions")),function([b,c]){const d=f[c];s(d)||a.isNull(d)||(e[b]=f[c])}),f.order&&(e.order=1*n(c.directions)[f.order]),e}},parseRecords:function(a){return a&&2===a.length&&q(a[0])&&o(a[1])?a[1]:a},fetch:function(b={}){const c=this._checkState(this.state),e=this.mode;"infinite"!=e||b.url||(b.url=this.links[c.currentPage]);const h=b.data||{};let k=b.url||this.url||"";p(k)&&(k=k.call(this));const l=k.indexOf("?");-1!=l&&(f(h,d(k.slice(l+1))),k=k.slice(0,l)),b.url=k,b.data=h;const n="client"==this.mode?j(this.queryParams,"sortKey"):g(j(this.queryParams,r(A.queryParams)),"order","directions","totalPages","totalRecords");i(n,function(b,d){b=p(b)?b.call(this):b,null!=c[d]&&null!=b&&a.isUndefined(h[b])&&(h[b]=c[d])},this);const q=p(this.queryParams.sortKey)?this.queryParams.sortKey.call(this):this.queryParams.sortKey,t=p(this.queryParams.order)?this.queryParams.order.call(this):this.queryParams.order;if(null!=q&&null!=c.sortKey&&null!=t&&null!=c.order)if(o(c.order)){h[t]=[];for(let a=0;a<c.order.length;a++)h[t].push(this.queryParams.directions[c.order[a]])}else h[t]=this.queryParams.directions[c.order+""];const u=m(g(this.queryParams,r(A.queryParams)));for(let a=0;a<u.length;a++){const b=u[a];let c=b[1];c=p(c)?c.call(this):c,null!=c&&(h[b[0]]=c)}if("server"!=e){const a=this,c=this.fullCollection,d=b.success;return b.success=function(g,h,i){i=i||{},s(b.silent)?delete i.silent:i.silent=b.silent;const j=g.models;"client"==e?c.reset(j,i):(c.add(j,f({at:c.length},f(i,{parse:!1}))),a.trigger("reset",a,i)),d&&d(g,h,i)},w.fetch.call(this,f({},b,{silent:!0}))}return w.fetch.call(this,b)},_makeComparator:function(a,b,c){const d=this.state;if(a=a||d.sortKey,b=b||d.order,a&&b)return c||(c=function(a,b){return a.get(b)}),function(d,e){let f,g=c(d,a),h=c(e,a);return(1===b&&(f=g,g=h,h=f),g===h)?0:g<h?-1:1}},setSorting:function(a,b,c){const d=this.state;d.sortKey=a,d.order=b=b||d.order;const e=this.fullCollection;let g=!1,h=!1;a||(g=h=!0);const i=this.mode;c=f({side:"client"==i?i:"server",full:!0},c);const j=this._makeComparator(a,b,c.sortValue),k=c.full,l=c.side;return"client"==l?k?(e&&(e.comparator=j),g=!0):(this.comparator=j,h=!0):"server"==l&&!k&&(this.comparator=j),g&&(this.comparator=null),h&&e&&(e.comparator=null),this}}),A=z.prototype;return z});
